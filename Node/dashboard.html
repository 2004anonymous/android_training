<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Entries</title>
    <link
      href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css"
      rel="stylesheet"
    />
  </head>
  <body>
    <div class="container mt-5">
      <h1 class="mb-4">Uploaded Entries</h1>

      <a href="http://localhost:3000" class="btn btn-primary"> Upload papers</a>
      <table class="table table-bordered" id="entriesTable">
        <thead class="thead-dark">
          <tr>
            <th>id</th>
            <th>File</th>
            <th>Department</th>
            <th>Semester</th>
            <th>Subject</th>
            <th>Year</th>
            <th>Action</th>
          </tr>
        </thead>
        <tbody id="entriesBody"></tbody>
      </table>
    </div>

    <!-- Edit Entry Modal -->
    <div class="modal" id="editModal">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h4 class="modal-title">Edit Entry</h4>
            <button type="button" class="close" data-dismiss="modal">
              &times;
            </button>
          </div>
          <div class="modal-body">
            <form id="editForm">
              <label for="editId">ID:</label>
              <input
                type="text"
                id="editId"
                name="id"
                class="form-control"
                readonly
              />
              <label for="editYear">Year:</label>
              <input
                type="text"
                id="editYear"
                name="year"
                class="form-control"
                required
              />
              <label for="editSemester">Semester:</label>
              <input
                type="text"
                id="editSemester"
                name="semester"
                class="form-control"
                required
              />
              <label for="editDepartment">Department:</label>
              <input
                type="text"
                id="editDepartment"
                name="department"
                class="form-control"
                required
              />
              <label for="editSubject">Subject:</label>
              <input
                type="text"
                id="editSubject"
                name="subject"
                class="form-control"
                required
              />
              <br />
              <button type="submit" class="btn btn-primary">
                Save Changes
              </button>
            </form>
          </div>
        </div>
      </div>
    </div>

    <!-- Include Bootstrap JS and Popper.js (you might need to adjust the paths) -->
    <script src="https://code.jquery.com/jquery-3.2.1.slim.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.12.9/umd/popper.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/js/bootstrap.min.js"></script>

    <script>
      async function fetchEntries() {
        try {
          const response = await fetch("/get-entries");
          const data = await response.json();

          console.log("Data received:", data);

          // Check if the response has the expected structure
          if (data && Array.isArray(data["details of the paper are:"])) {
            // Corrected key
            const entries = data["details of the paper are:"];
            console.log(data);

            const entriesBody = document.getElementById("entriesBody");
            entriesBody.innerHTML = "";
            entries.forEach((entry) => {
              console.log("Entry:", entry);
              const row = document.createElement("tr");
              row.innerHTML = `
    <td>${entry.id}</td>
    <td>${entry.file}</td>
    <td>${entry.dept}</td>
    <td>${entry.sem}</td>       
    <td>${entry.sub}</td>
    <td>${entry.year}</td>
    <td>
      <button class="btn btn-primary" onclick="openEditModal(${entry.id}, ${entry.sem}, '${entry.sub}', ${entry.year}, '${entry.dept}')">Edit</button>
      <button class="btn btn-danger" onclick="deleteEntry(${entry.id})">Delete</button>
    </td>
  `;
              entriesBody.appendChild(row);
            });
          } else {
            console.error("Invalid data format:", data);
          }
        } catch (error) {
          console.error("Error fetching entries:", error);
        }
      }

      // Call fetchEntries on page load
      fetchEntries();

      async function openEditModal(id, sem, sub, year, dept) {
        // Set values in the edit modal form
        document.getElementById("editId").value = id;
        document.getElementById("editId").readOnly = true;
        document.getElementById("editYear").value = year;
        document.getElementById("editSemester").value = sem;
        document.getElementById("editDepartment").value = dept;
        document.getElementById("editSubject").value = sub;

        // Show the edit modal
        $("#editModal").modal("show");

        // Handle form submission
        document.getElementById("editForm").onsubmit = function (event) {
          event.preventDefault();
          // Call your editEntry function here passing the values from the form
          // You need to implement the editEntry function to handle the API request for editing
          // Once the entry is edited successfully, you can close the modal and refresh the entries
          editEntry(id, {
            id: id,
            year: document.getElementById("editYear").value,
            sem: document.getElementById("editSemester").value,
            dept: document.getElementById("editDepartment").value,
            sub: document.getElementById("editSubject").value,
          });
        };
      }

      async function editEntry(id, updatedData) {
        try {
          const response = await fetch(`/paper/edit/${id}`, {
            method: "PUT",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify(updatedData),
          });

          const result = await response.json();
          console.log(result);

          // Close the modal after successful edit
          $("#editModal").modal("hide");

          // Refresh the entries after edit
          fetchEntries();

          // Show alert
          alert("Paper has been edited!");
        } catch (error) {
          console.error("Error editing entry:", error);
        }
      }
      async function deleteEntry(entryId) {
        try {
          const response = await fetch(`/paper/delete/${entryId}`, {
            method: "DELETE",
            headers: {
              "Content-Type": "application/json",
            },
          });

          const result = await response.json();
          console.log(result);

          // Refresh the entries after deletion
          fetchEntries();

          // Show alert
          alert("Paper has been deleted!");
        } catch (error) {
          console.error("Error deleting entry:", error);
        }
      }
    </script>
  </body>
</html>
